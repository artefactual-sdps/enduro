name: SBOM (Dependency-Track)

on:
  push:
    branches:
      - main
  release:
    types: [published]

concurrency:
  group: sbom-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  PROJECT_NAME: ${{ github.repository_owner }}-${{ github.event.repository.name }}
  PROJECT_VERSION: ${{ (github.event_name == 'release' && github.event.release.tag_name) || github.ref_name }}

jobs:
  sbom:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Dependency-Track secrets
        run: |
          if [ -z "${DEPENDENCY_TRACK_HOSTNAME}" ] || [ -z "${DEPENDENCY_TRACK_API_KEY}" ]; then
            echo "Dependency-Track secrets not configured; set DEPENDENCY_TRACK_HOSTNAME and DEPENDENCY_TRACK_API_KEY."
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ env.PROJECT_VERSION }}

      - name: Set up Trivy cache
        uses: actions/cache@v5
        with:
          path: .trivycache
          key: ${{ runner.os }}-trivy-${{ hashFiles('**/go.sum', '**/package-lock.json', '**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-trivy-

      - name: Generate SBOM (CycloneDX JSON)
        uses: aquasecurity/trivy-action@0.34.1
        env:
          TRIVY_NO_PROGRESS: "true"
        with:
          scan-type: fs
          format: cyclonedx
          output: sbom.cdx.json
          cache-dir: .trivycache
          exit-code: "0"

      - name: Upload to Dependency-Track
        uses: DependencyTrack/gh-upload-sbom@v3
        with:
          serverhostname: ${{ secrets.DEPENDENCY_TRACK_HOSTNAME }}
          apikey: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}
          autocreate: true
          projectname: ${{ env.PROJECT_NAME }}
          projectversion: ${{ env.PROJECT_VERSION }}
          parentname: artefactual-sdps-enduro
          bomfilename: sbom.cdx.json
