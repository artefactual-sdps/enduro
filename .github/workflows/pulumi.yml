on: [workflow_dispatch]
name: Pulumi
jobs:
  dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3.0.2
      - name: Install Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18.x
      - name: Download Go dependencies
        run: go mod download
        working-directory: hack/pulumi
      - name: Refresh and update Pulumi stack
        uses: pulumi/actions@v3.18.1
        with:
          command: up
          refresh: true
          stack-name: dev
          work-dir: hack/pulumi
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_TOKEN }}
          DOCKER_BUILDKIT: 1
      - name: Configure kubectl
        uses: azure/k8s-set-context@v3.0
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.DO_DEV_KUBECONFIG }}
      - name: Flush existing data
        run: |
          kubectl delete job --all -n sdps
          kubectl create -f hack/kube/tools/mysql-recreate-databases-job.yaml
          kubectl create -f hack/kube/tools/minio-recreate-buckets-job.yaml
          kubectl create -f hack/kube/tools/opensearch-delete-index-job.yaml
          kubectl wait --for=condition=complete --timeout=120s job --all -n sdps
          kubectl rollout restart deployment temporal -n sdps
          kubectl rollout restart deployment enduro -n sdps
          kubectl rollout restart statefulset enduro-a3m -n sdps
